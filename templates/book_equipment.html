{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0">üì¶ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞: "{{ project.title }}"</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Å—ä—ë–º–∫–∏:</label>
                        <input type="date" class="form-control w-25" name="date" id="datePicker" required>
                        <div class="form-text">–ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã —Å—Ç–∞—Ç—É—Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
                    </div>

                    <h5 class="mb-3">–î–æ—Å—Ç—É–ø–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ:</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">–í—ã–±—Ä–∞—Ç—å</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–¢–∏–ø</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in equipment %}
                                <tr id="row-{{ item.id }}">
                                    <td class="text-center">
                                        <input class="form-check-input equipment-checkbox" 
                                            type="checkbox" 
                                            name="equipment" 
                                            value="{{ item.id }}"
                                            id="checkbox-{{ item.id }}"
                                            {% if item.is_broken %}disabled{% endif %}>
                                    </td>
                                    <td>{{ item.name }}</td>
        
                                    <td>
                                        {% if item.type == 'camera' %} 
                                            <span class="badge bg-primary">–ö–∞–º–µ—Ä–∞</span>
                                        {% elif item.type == 'light' %} 
                                            <span class="badge bg-warning text-dark">–°–≤–µ—Ç</span>
                                        {% elif item.type == 'prop' %} 
                                            <span class="badge bg-secondary">–†–µ–∫–≤–∏–∑–∏—Ç</span>
                                        {% else %}
                                            {{ item.type }}
                                        {% endif %}
                                    </td>
                                    <td id="status-{{ item.id }}">
                                        {% if item.is_broken %}
                                            <span class="badge bg-danger">–í —Ä–µ–º–æ–Ω—Ç–µ</span>
                                        {% else %}
                                            <span class="badge bg-secondary">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                    {% endfor %}
                              </tbody>
                        </table>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="/projects" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</a>
                        <button type="submit" class="btn btn-primary px-4">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª–µ –¥–∞—Ç—ã
    const dateInput = document.getElementById('datePicker');
    
    // –°–º–æ—Ç—Ä–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã
    dateInput.addEventListener('change', function() {
        const selectedDate = this.value;
        if (!selectedDate) return;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä (API)
        fetch(`/api/check_availability?date=${selectedDate}`)
            .then(response => response.json())
            .then(busyIds => {
                // busyIds - —ç—Ç–æ –º–∞—Å—Å–∏–≤ ID –∑–∞–Ω—è—Ç—ã—Ö –≤–µ—â–µ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä
                
                // –ü—Ä–æ—Ö–æ–¥–∏—Ç—Å—è –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º —Ç–∞–±–ª–∏—Ü—ã
                const checkboxes = document.querySelectorAll('.equipment-checkbox');
                
                checkboxes.forEach(checkbox => {
                    const equipmentId = parseInt(checkbox.value);
                    const statusCell = document.getElementById(`status-${equipmentId}`);
                    const row = document.getElementById(`row-${equipmentId}`);
                    
                    // –ï—Å–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ —Å–ª–æ–º–∞–Ω–æ, –µ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç
                    if (checkbox.disabled && statusCell.innerText.includes('–í —Ä–µ–º–æ–Ω—Ç–µ')) {
                        return;
                    }

                    if (busyIds.includes(equipmentId)) {
                        // –ó–ê–ù–Ø–¢–û: –ë–ª–æ–∫–∏—Ä—É–µ—Ç –≥–∞–ª–æ—á–∫—É –∏ –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å
                        checkbox.disabled = true;
                        checkbox.checked = false;
                        statusCell.innerHTML = '<span class="badge bg-danger">‚õî –ó–∞–Ω—è—Ç–æ</span>';
                        row.classList.add('table-secondary'); // –î–µ–ª–∞–µ—Ç —Å—Ç—Ä–æ–∫—É —Å–µ—Ä–æ–π
                    } else {
                        // –°–í–û–ë–û–î–ù–û: –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç
                        checkbox.disabled = false;
                        statusCell.innerHTML = '<span class="badge bg-success">‚úî –î–æ—Å—Ç—É–ø–Ω–æ</span>';
                        row.classList.remove('table-secondary');
                    }
                });
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
    });
</script>
{% endblock %}